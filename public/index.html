<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" type="text/css" href="stylesheets/bootstrap.min.css">
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-5">
            <form id="itinerary">
                <div class="form-group">
                    <label for="origin">Origin*</label>
                    <input type="text" class="form-control" id="origin" aria-describedby="emailHelp" placeholder="Enter departure city">
                </div>
                <div class="form-group">
                    <label for="departure_date">Departure Date*</label>
                    <input type="text" class="form-control" id="departure_date" placeholder="2018-03-03--2018-03-15">
                </div>
                <!--<div class="form-check">-->
                    <!--<input type="checkbox" class="form-check-input" id="one_way">-->
                    <!--<label class="form-check-label" for="one_way">One way trip</label>-->
                <!--</div>-->
                <!--Lots of itinerary will be removed because of this. can be removed-->
                <!--<div class="form-check">-->
                    <!--<input type="checkbox" class="form-check-input" id="direct">-->
                    <!--<label class="form-check-label" for="direct">Direct flights only</label>-->
                <!--</div>-->
                <div class="form-group">
                    <label for="duration">Duration</label>
                    <input type="number" class="form-control" id="duration" placeholder="Days">
                </div>
                <div class="form-group">
                    <label for="max_price">Max_price</label>
                    <input type="number" class="form-control" id="max_price" placeholder="">
                </div>
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
        </div>
        <div class="col-md-7">

        </div>
    </div>
</div>
<script
        src="http://code.jquery.com/jquery-3.3.1.min.js"
        integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>

<script>
    var apikey = "YTpayeI2uV2Ae5DxlH4GlcIW7iawOFll";
    function triggerInspirationAPI(origin, departure_date, duration, max_price) {
        var payload = {
            "apikey": apikey,
            "origin" : origin,
            "departure_date" : departure_date,
            "duration" : duration,
            "max_price" : max_price
        };
        var dest;
        $.ajax({
            url: "https://api.sandbox.amadeus.com/v1.2/flights/inspiration-search",
            type: "GET",
            data: payload,
            async: false
        }).done(function(response) {
            console.log(response.results.slice(0,2));
            if(response.status && response.status === 400) {
                dest = false;
            }
            else {
                dest = response;
            }
        }).fail(function (data) {
            console.log(data);
        });
        return dest;
    }

    function isDurationComplete(duration) {
        return duration <=1;
    }

    function getDestinationPerDate(firstCall, duration) {
        var destinations = [];
        var setOfDates = new Set();
        for (var i=0; i < firstCall.length; i++) {
            if(!setOfDates.has(firstCall[i].departure_date)) {
                destinations.push(firstCall[i]);
                setOfDates.add(firstCall[i].departure_date);
            }
            if(setOfDates.length == duration+1) {
                break;
            }
        }
        return destinations;
    }

    $(document).ready(function() {
        //Flight Inspiration API
        $("#itinerary").on("submit", function(event) {
            event.preventDefault();
            //get form data
            var duration = $("#duration").val();
            var departure_date = $("#departure_date").val();
            var origin = $("#origin").val();
            var max_price = $("#max_price").val();
            if(duration === "" ) {
                duration = 10;
            }
            if(max_price === "") {
                max_price = 999999999;
            }
            //get dates
            //var departureDates = getDepartureDates(departure_date, duration);
            //get dest to start
            var firstCall = triggerInspirationAPI(origin, departure_date,
                duration, max_price);
            //get destination per date
            var destinations = getDestinationPerDate(firstCall.results, duration);
            duration = duration - 2;
            departure_date = new Date(departure_date.substr(0,10));
            //departure_date.setDate(departure_date.getDate()+2);
            var list = [];
            var cities = 1;
            for(var i =0; i<destinations.length;i++) {
                list.push([origin, destinations[i].destination]);
            }

            outer: while (!isDurationComplete(duration) && max_price > 0 && cities <= 5) {
                while (destinations.length !== 0) {
                    var dest = destinations.pop();
                    max_price = max_price - dest.price;
                    departure_date = new Date(departure_date.getTime() + 24*2*60*60*1000);
                    var day = departure_date.getDate()<=9?"0"+departure_date.getDate():departure_date.getDate();
                    var month = departure_date.getMonth()+1;
                    if(month <= 9) {
                        month="0"+month;
                    }
                    var year = departure_date.getFullYear();
                    var nextDest = triggerInspirationAPI(dest.destination, year+"-"+month+"-"+day,
                        duration, Math.trunc(max_price));
                    if(!nextDest) {
                        continue;
                    }
                    destinations.push(nextDest.results[0]);
                    destinations.push(nextDest.results[1]);
                    var lastEntry = list[list.length-1];
                    var temp = Object.create(lastEntry);
                    lastEntry.concat(nextDest.results[0].destination);
                    list.push(lastEntry)
                    temp.concat(nextDest.results[1].destination);
                    list.push(temp);
                    cities++;
                }
            }
            console.log(list);

        });
    });

</script>
</body>
</html>